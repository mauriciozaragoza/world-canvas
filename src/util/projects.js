var paper = require('paper'),
	db = require('./db.js'),
	schedule = require('node-schedule');

var countries = ["58e69a293e3d65294bd972b467c40996","06fa567b72d78b7e3ea746973fbbd1d5","e892e780304dc3ef15e69b9f3fed3669","fa3c7f2b5daea5f9e813128f962e6ec4","a2c29192484301fa800100e16e494acf","e182ebbc166d73366e7986813a7fc5f1","2c64c5cf613d8b9f4f7f3980d29aca10","0a40e3c91a3a55c9a37428c6d194d0e5","406a827681ba573eb9029a9a41cae6d7","6b712da7b7ccf80851beb06de6c32e6c","5b61a1b298a0d06efa6933a97e68d763","25ec916d56b8212e569dbf2e4e4b51d4","1e5342b2de8f485d2cc77947a6154b3f","6cc98ba2045fe4098d24356d14447085","fa868488740aa25870ced6b9169951fb","546a9a80eb981c7f0aabcaeb34d9514e","9a231c14a3416b1055b8ffb960151aee","1baa5a77aeff33338948c1e0c4466462","87a47565be4714701a8bc2354cbaea36","9d3d9048db16a7eee539e93e3618cbe7","925ab312a51a924ab68d9812baa788ff","d3dcf429c679f9af82eb9a3b31c4df44","e45fbcf6ca3b21f17c5f355728a2fbec","ddd70bbaf5be05e1e9caded444c03095","5089fa881630360a9b3361469c1a0c5d","277b18808bb6fba9845a813795fe8baa","7b60a39fc2a49bbac1b3426abb5ada4b","5fc810cf62601df84b7923b9964c53e6","81043f8c681575bca3e4eff6afbd9db9","c79bda0e66f07bee662a6840b907bf39","19d3326f3137cbadd21ce901a9bed4a7","cf3882f1c43ab22bff0bd9d82d83251b","fc37fbde490e37c1258738a18b9aa4c7","461b1990fe86af962cd15a16a26dceb8","7b8d2f92148f52cad46e331936922e80","af7f0273997b9b290bd7c57aa19f36c2","fd7030716334c4db5a83bbbc0f7c7f6f","707354872d4e8210a2a573b99721b1fb","3e8d115eb4b32b9e9479f387dbe14ee1","a5c8c3544bc49ebacde4ffe04bf34de0","b8ea98de1a83f61d1976027741a458be","758951cac5e62129e654698c8ca0333b","fc089489555aee7519548ff7f589f384","5bc574a47246f122016869b32a6aa6f0","1c2903397d8833382673bab22aa8b937","833e36d1a5a93dedb10c85f50ced9ce7","aa53ca0b650dfd85c4f59fa156f7a2cc","42983b05e2f2cc22822e30beb7bdd668","dd480f25b31ec27223fee2c6edcacb3c","4170acd6af571e8d0d59fdad999cc605","5202c6586cac8bee468e86d1ff854231","534ac75c2e8ac3e3fe7bc32bb8c6e34a","1d7b33fc26ca22c2011aaa97fecc43d8","3ba0f40775d6d6ace27ef929f5be3cdf","fd4c638da5f85d025963f99fe90b1b1a","c83f077534a373cb63a0a91969fdce54","9025a1ae8c64158622b7428028f0d2bd","928568b84963ceb76aaaa2cae9afdbfa","dd65ef9a5579d4e518c6d4abbd0cb1c6","27a5773a603825cc6999e48cc2b1b270","2ecda7a0252b442ac6ecf47462119f51","c23fa9996925b610710d93e28c59a3e2","3fd6b696867d70225deda7868308679b","fbe46383db390907541a234bec7f2424","d38212a0c0e98f678feaaa5a8b9167f5","8d36b361a4794422c70681586a957350","1bd3a0484883ca6deaada8395a8f6e85","a57b8491d1d8fc1014dd54bcf83b130a","ae41a6d38b78679b4675941ff0c0c92d","8c8ba29dafd95af91e280d1e80b81773","c0398fb66542bbcf6e14417a0a6751f4","a0137b712fd26c429ccd6a13541b538d","f0aa03aaca953a9a63b4459663d00134","11aedd0e432747c2bcd97b82808d24a0","c07b0b4d7660314f711a68fc47c4ab38","21080924b5d026e4a6011eb987ae1ec8","c3ee2af7ca7bbe492f11cf36a6a7cea7","cd957338498985e538753ea8d071e0f9","64f3bd1741ab8d6ba545a1ae09bb8728","f803729628adf4199f224c2a225038e9","3a52f3c22ed6fcde5bf696a6c02c9e73","6848ae6f8e786062f1b23476c9ecd258","02c73fe4efabc7a908c3768c18d8ffe3","f214a7d42e0de5875d55189e01e2e187","ad70939237c6f0d638fe79884d91449b","56a036735e46821195a55359c5ad144f","ad2d8ee7d788dcf41f399818f639cb64","30531a35cc61a56dc5b23717afeae6c6","cd6a9bd2a175104eed40f0d33a8b4020","accb66f0ecd826aac89065990e1da97f","c17d19f7520be36addbeb5d2c76ab7cf","1daf9c39806ca426cd65151747932f6c","90d64eeba8247d656ef6b4800ec0f52f","36a12a753997a4032c351f4c6a12c416","ac4a2766028a717ff89985bc85bf5e50","69e1aafeccc558d92f93bcf86fb913f5","35b5282113b88c2fe23dcbec9f0258c1","0bfc16cc12effc1bae4d3766c4f2257d","c86ee0d9d7ed3e7b4fdbf486fa6c0ebb","b718adec73e04ce3ec720dd11a06a308","4f74d343f26bbd58a8cbbad2cab6a704","560e51228bc1672591fd8833265b6234","d2cb7bbc0d23f34c4255d924076e902f","88588bacf0dad76870d7ede67a0ddbdf","cd32106bcb6de321930cf34574ea388c","52c5706bc98f911ffbc794f5ffab068d","24d22e03afb23edb45c6c8cfa16a280e","60aea2edd1105dd93c39e6e193080736","4aceb7d6b4564ec96bc6605cd5af37e7","518f4a738816e5ef78463929ef311f26","609caf44b732b054dda5860569e7e92e","da2be3f8b1640de6534fea0e9744cccb","38dd815e66dbd0d47a2b876ca442e987","cd37b867bc72de7092be76ffdd85630c","56d721ccadb8bbfd8b47390d82a6ea4b","6b40fe07a0e5a93eef07242975e83ec1","a7bdee32cb21f0abbf9f878cb06cfe16","c951270e425b15fc20c64da4341c1d89","e8280907c8d32d5af0f36e5442e84a34","90a7c45eaffbd575ca6fb361e6d170a4","c2d75724334cab079503451aab65ba04","14efbb26a99dc4820b9928957704cb8f","c562607189d77eb9dfb707464c1e7b0b","920d0c66f3d2ad926a6d590a5d244bd9","eb0459bfce4185888ecf61fb07987581","fbd1e7ba9564863b88d5c43cb833afaf","ba2a034f4d913f87fe07cad29368d114","f9f315de90492c8259307985379c2a4e","75dfaed2dded20f8b8d376ddc7212f23","77d96fc8e5c080038b043ead02dadfc3","d01fd9b01e9dde8bd3dc247afbfb7218","08ad08f6491037714d09263a79bebfba","002f27e5064e874ecf4f5def17d1b797","51f581937765890f2a706c77ea8af3cc","d5c44258d51659f96279c470ce8185dc","e5919ba9cf2e803bdbc98334a7f64daa","2775a63846b6232662fff87128061bbd","0b98720dcb2cc6fd60358a45dfbc5b87","ff94b93682a7bb18a97d720c82e253cb","7dc10e66da5549d351765bd940b81be9","92a54b358b4cf53cca4095e4697e1004","943afaf25ac17fe7bc39fdaae916e3a4","7a663caea1b722a63dc2868158ed584d","2a6039655313bf5dab1e43523b62c374","ac6ad5d9b99757c3a878f2d275ace198","ad05f78187c942f9dd521605fa81f1ba","d4cd0dabcf4caa22ad92fab40844c786","c3938dd81fe1366e93d2e29a6ffe2005","8bc2afe7028c861affc259b1c8a17640","796834e7a2839412d79dbc5f1327594d","d9681d05860552e9c3113da381f916fc","90581d96b500fd2d3fd701a583409cb8","8e3eb2c69a184ad1d448afe5985f50b3","fff6fa4fe7ddec3a931ca45d9e626ae7","dc33066c3993e0d50896e533fd692ce0","bf7410a9ee723b715ee14837f2328888","9393cb701efd9874f38be79bca77cfb9","227dc251e1411f6b6fffcd1c30486f4d","c90a918b859bd1e56cf99af6246b128e","c2f3f489a00553e7a01d369c103c7251","bfbebc0782222b0f8f991f1405ec537d","d71bdd22c8bb93b8d287dce6f46aed25","6e029fbfa817dfc458598a5d38a6755f","d3d4c5deb455ac79dd5ff47c88bd65d9","06f6a489209115c5cef3f45036aad3ec","49f38fe03598e4d63f4a0a8791c9c8b9","0c145a13e49b47abccd510e5c899d80c","3acf83834396fa1c878707132ead62b8","a25496ebf095e4198da4088449c83ac6","7b6166324dc52f374d908e03602b1daf","9b7d173b068dc4d5517bfae92d676437","35357b9c8fe4d3273d0237ecc8ff2e75","0fe75a5189c2ea3f123621d098ddd03e","0ab687c6a13802a6674d5327e3d4177e","adf72a0db2cbd36462d3aa203eda902f","f5b15f58cabad73d1bf2de7bcb89db6c","f9308c5d059650ee40cab30bad1e96d0","5c6dc3d436504b7a65191cafe28212ee","ec5704f0d56945d1e5b8f9a2384a2b4b","aa2b36dabd254260f584015a9e0c5c98","6907b8692fb04b36ab78f1238a876284","21b7eb30013b04776f5b06bc59209391","b7128ad1d9b838be26989d1037a8c987","54df3baef130c81e6ae8432a2567320a","4e0d4f6ce30646f5a3f3e2a7422c1c5a","ec8e57d71f07e31203035548b79d03c8","3dd6b9265ff18f31dc30df59304b0ca7","92666505ce75444ee14be2ebc2f10a60","8d7e99c73cd5a10adaaf4c9f9a520368","6a65edb0cc17d66c677814115b1477f5","74b8d5453b654b3a79e7b8985a2fc71c","0f177369a3b71275d25ab1b44db9f95f","13dd621f27110108a10a88e99fe9ceaf","ce774d9cab3ae0bdf522cd0839bed364","a06b33d1ea28e90733617ec889d4e76e","98d0360b392de5f1d53acdd6489b6e88","68caa82010645c82f5e37cbe337cae1c","71a75a167c33c58bfb561764255c880a","04c19fa1e772ab66f0aad2efe61f25cd","2c16b194a0d9037002e9ef6580925697","38f99abbc1d339c277c0669e7bc373c0","8cb2010d27e13509d364436256e972c0","7f551f461b16dc116f18a47a7df73178","715f9a16ad2c8290efe57b63d279d8fa","f003c44deab679aa2edfaff864c77402","1ee0bf89c5d1032317d13a2e022793c8","174fe2539889bbf873e7c2de71949074","3d9975706be3087ca199f440b1589b9e","6e4f62232fe7c185a8274bac42e333bb","13c4998a4a401a2431779d247f7d6143","5b79c40fa7c2bd12dd2df53c4a2b6836","c4534c00ebdb14023f4f538811df5209","2de960c6ab3cef39a9a2298fb58e503d","b312cc8653ffd4c30bce0e071cefb600","304917b92bc3dc0953aab8356f74c02c","df1f3edb9115acb0a1e04209b7a9937b","947d7d61cd9ae4cb2ccd29438d7f9974","ebe021079e5a3c4f42ca6119eab92633","ac7a4fbd0d788d94f43454817e1c208c","ff9c072d42a94d0a5112613019b54eae","271ddf829afeece44d8732757fba1a66","1db208cbcff273e672b3acc7a3a37a3e","3943d8795e03e8e3307b5b71eac1b669","ea8a1a99f6c94c275a58dcd78f418c1f","79cba1185463850dedba31f172f1dc5b","7516fd43adaa5e0b8a65a672c39845d2","40a71d08f9b41d55b8d217465cf2845e","9f72f02c2586ff913854a844f10d9a99","195dc214249dab3c31906b4b9f83d503","bce87c857571353d52a984d051446b37","3a11129c3467b1bcf46522b8e2ab3328","a99877f71bd9b0fa0159103dbedb5c0f","e14da64a5617a7f7260ccb29c48fa866","4d6d91b1797aad52f98db63d197959a6","893015dbee3ceb57a09c96ef71045081","94e067c4b06f611523c0d02048128160","088a2013906137902c9832d2f5a3a940","63cf9a25c78f494840f05187a0c79eb2","70f73ee5133fa9c2b13516067fabfd87","31645929703e0ca8727296992f4dc763"];

exports.countryCodes = ["AX","AF","AL","DZ","AS","AD","AO","AI","AQ","AG","AR","AM","AW","AU","AT","AZ","BS","BH","BD","BB","BY","BE","BZ","BJ","BM","BT","BO","BA","BW","BV","BR","IO","BN","BG","BF","BI","KH","CM","CA","CV","KY","CF","TD","CL","CN","CX","CC","CO","KM","CD","CG","CK","CR","CI","HR","CU","CY","CZ","DK","DJ","DM","DO","EC","EG","SV","GQ","ER","EE","ET","FK","FO","FJ","FI","FR","GF","PF","TF","GA","GM","GE","DE","GH","GI","GR","GL","GD","GP","GU","GT","GN","GW","GY","HT","HM","HN","HK","HU","IS","IN","ID","IR","IQ","IE","IL","IT","JM","JP","JO","KZ","KE","KI","KP","KR","KW","KG","LA","LV","LB","LS","LR","LY","LI","LT","LU","MO","MK","MG","MW","MY","MV","ML","MT","MH","MQ","MR","MU","YT","MX","FM","MD","MC","MN","MS","MA","MZ","MM","NA","NR","NP","NL","AN","NC","NZ","NI","NE","NG","NU","NF","MP","NO","OM","PK","PW","PS","PA","PG","PY","PE","PH","PN","PL","PT","PR","QA","RE","RO","RU","RW","SH","KN","LC","PM","VC","WS","SM","ST","SA","SN","CS","SC","SL","SG","SK","SI","SB","SO","ZA","GS","ES","LK","SD","SR","SJ","SZ","SE","CH","SY","TW","TJ","TZ","TH","TL","TG","TK","TO","TT","TN","TR","TM","TC","TV","UG","UA","AE","GB","US","UM","UY","UZ","VU","VA","VE","VN","VG","VI","WF","EH","YE","ZM","ZW"];
exports.countries = countries;
exports.projects = null;

function initializeProjects() {
	exports.projects = {};

	for (var i = 0; i < countries.length; i++) {
		exports.projects[countries[i]] = {
			project: new paper.Project(),
			external_paths : {},
			dirty : false
		};

		db.load(countries[i]);
	}
}

initializeProjects();

// -----------
// JOBS
// -----------

var saveJob = new schedule.RecurrenceRule();
saveJob.minute = new schedule.Range(0, 59, 1);

schedule.scheduleJob(saveJob, function () {
    for (var i = 0; i < countries.length; i++) {
    	if (exports.projects[countries[i]].dirty) {
			console.log("saving room: " + countries[i]);
			exports.projects[countries[i]].dirty = false;
			db.storeProject(countries[i]);
    	}
	}
});

var newCanvasJob = new schedule.RecurrenceRule();
newCanvasJob.minute = new schedule.Range(0, 59, 2);

schedule.scheduleJob(newCanvasJob, function () {
    console.log("Creating new canvas");

    for (var i = 0; i < countries.length; i++) {
    	db.archiveProject(countries[i], function (data) {
    		exports.projects[data.name].project = new paper.Project();
    	});
	}
});